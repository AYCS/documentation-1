- type: parallel
  name: testing
  steps:
    - type: serial
      name: prepare_site
      steps:
        - name: jet_release_notes
          service: aws
          command: sh bin/jet.sh
          encrypted_dockercfg_path: dockercfg.encrypted
        - name: build
          service: ci
          command: bash bin/build.sh
          encrypted_dockercfg_path: dockercfg.encrypted
        - name: post-process
          service: ci
          command: gulp post-process
    - type: serial
      name: linters
      service: ci
      encrypted_dockercfg_path: dockercfg.encrypted
      steps:
        - name: SCSS
          command: bundle exec scss-lint
        - name: JSON
          command: gulp lint
        - name: Jekyll
          command: bundle exec jekyll doctor
- name: fail_master_on_forks
  service: ci
  tag: master
  command: sh bin/check_fork.sh
- type: parallel
  name: deploying
  steps:
  - type: serial
    tag: "^(master|staging/.*|private/.*)$"
    steps:
      - name: s3_sync
        service: aws
        command: sh bin/s3.sh sync
        encrypted_dockercfg_path: dockercfg.encrypted
      - name: s3_website
        service: aws
        command: sh bin/s3.sh configure_website _website.json
        encrypted_dockercfg_path: dockercfg.encrypted
      - name: s3_lifecycle
        service: aws
        command: sh bin/s3.sh configure_lifecycle _lifecycle.json
        encrypted_dockercfg_path: dockercfg.encrypted
      - name: s3_robots
        service: aws
        command: sh bin/s3.sh robots
        encrypted_dockercfg_path: dockercfg.encrypted
      - name: swiftype
        service: ci
        command: sh bin/swiftype.sh
  - type: push
    tag: "^master$"
    name: push_docker_hub
    service: documentation
    image_name: codeship/documentation
    image_tag: latest
    registry: https://index.docker.io/v1/
    encrypted_dockercfg_path: dockercfg.encrypted
